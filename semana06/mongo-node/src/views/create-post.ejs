<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crear Post - Social Media</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    .create-form {
      max-width: 700px;
      margin: 30px auto;
    }
    .form-card {
      border-radius: 20px !important;
      box-shadow: 0 15px 50px rgba(0,0,0,0.1) !important;
      overflow: hidden;
      background: white;
    }
    .card-title {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white !important;
      padding: 25px !important;
      margin: 0 !important;
      font-size: 1.5rem;
    }
    .form-content {
      padding: 30px !important;
    }
    .input-field {
      margin-bottom: 25px;
    }
    .input-field input[type=text]:focus,
    .input-field input[type=url]:focus,
    .input-field textarea:focus {
      border-bottom: 2px solid #667eea !important;
      box-shadow: 0 1px 0 0 #667eea !important;
    }
    .input-field input[type=text]:focus + label,
    .input-field input[type=url]:focus + label,
    .input-field textarea:focus + label {
      color: #667eea !important;
    }
    .btn-modern {
      background: linear-gradient(135deg, #667eea, #764ba2) !important;
      border-radius: 25px;
      padding: 0 30px;
      font-weight: 500;
      text-transform: none;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
    }
    .btn-modern:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
    }
    .btn-cancel {
      background: transparent !important;
      color: #667eea !important;
      border: 2px solid #667eea;
      border-radius: 25px;
      padding: 0 25px;
      transition: all 0.3s ease;
    }
    .btn-cancel:hover {
      background: #667eea !important;
      color: white !important;
    }
    .image-preview {
      max-width: 100%;
      border-radius: 12px;
      margin: 15px 0;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .hashtag-preview {
      margin-top: 15px;
    }
    .hashtag-preview .chip {
      background: linear-gradient(45deg, #667eea, #764ba2) !important;
      color: white !important;
      border-radius: 20px;
      font-weight: 500;
      margin: 2px 4px 2px 0;
    }
    .error-alert {
      background: linear-gradient(45deg, #ff6b6b, #ff8e8e) !important;
      color: white !important;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    select {
      border-radius: 8px !important;
    }
    .dropdown-content {
      border-radius: 8px !important;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1) !important;
    }
  </style>
</head>
<body>

  <nav style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
    <div class="nav-wrapper container">
      <a href="/" class="brand-logo" style="font-weight: 600; font-size: 1.8rem;">
        <i class="material-icons">connect_without_contact</i> SocialHub
      </a>
      <ul class="right">
        <li><a href="/posts" style="background: rgba(255,255,255,0.15); border-radius: 20px; padding: 0 15px; margin: 0 5px;"><i class="material-icons left">arrow_back</i>Volver</a></li>
      </ul>
    </div>
  </nav>

  <div class="container create-form">
    <div class="card form-card">
      <div class="card-title">
        <i class="material-icons left">create</i>
        Crear Nuevo Post
      </div>
      
      <div class="form-content">
        <% if (typeof error !== 'undefined') { %>
          <div class="card-panel error-alert">
            <i class="material-icons left">error</i><%= error %>
          </div>
        <% } %>

        <form action="/posts/create" method="POST">
          <div class="input-field">
            <select name="userId" required>
              <option value="" disabled selected>Selecciona tu perfil</option>
              <% users.forEach(user => { %>
                <option value="<%= user._id %>" <%= (typeof formData !== 'undefined' && formData.userId === user._id.toString()) ? 'selected' : '' %>>
                  <%= user.name %> <%= user.lastName %>
                </option>
              <% }); %>
            </select>
            <label>Autor del Post</label>
          </div>

          <div class="input-field">
            <input name="title" type="text" maxlength="30" required 
                   value="<%= (typeof formData !== 'undefined') ? formData.title || '' : '' %>">
            <label for="title">Título del Post *</label>
            <span class="helper-text" data-error="El título es requerido (mínimo 5, máximo 30 caracteres)">Máximo 30 caracteres</span>
          </div>

          <div class="input-field">
            <textarea name="content" class="materialize-textarea" required><%= (typeof formData !== 'undefined') ? formData.content || '' : '' %></textarea>
            <label for="content">¿Qué estás pensando? *</label>
            <span class="helper-text" data-error="El contenido es requerido (mínimo 10 caracteres)">Comparte tus ideas...</span>
          </div>

          <div class="input-field">
            <input name="imageUrl" type="url" id="imageUrl" 
                   value="<%= (typeof formData !== 'undefined') ? formData.imageUrl || '' : '' %>"
                   onchange="previewImage(this.value)">
            <label for="imageUrl">URL de Imagen (opcional)</label>
            <span class="helper-text">Agrega una imagen a tu post</span>
          </div>
          
          <div id="imagePreview">
            <img id="previewImg" class="image-preview responsive-img" alt="Vista previa">
          </div>

          <div class="input-field">
            <input name="hashtag" type="text" id="hashtagInput" 
                   value="<%= (typeof formData !== 'undefined') ? formData.hashtag || '' : '' %>"
                   onkeyup="previewHashtags(this.value)">
            <label for="hashtagInput">Hashtags (opcional)</label>
            <span class="helper-text">Separa los hashtags con comas. Ej: tecnología, programación, nodejs</span>
          </div>
          
          <div id="hashtagPreview" class="hashtag-preview"></div>

          <!-- Botones -->
          <div class="row" style="margin-top: 40px;">
            <div class="col s12 right-align">
              <a href="/posts" class="btn-flat btn-cancel waves-effect">
                <i class="material-icons left">cancel</i>Cancelar
              </a>
              <button type="submit" class="btn btn-modern waves-effect waves-light" style="margin-left: 15px;">
                <i class="material-icons left">send</i>Publicar Post
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      M.AutoInit();
      
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      
      M.textareaAutoResize(document.querySelectorAll('textarea'));
      
      M.updateTextFields();
      
      const imageUrl = document.getElementById('imageUrl').value;
      if (imageUrl) previewImage(imageUrl);
      
      const hashtags = document.getElementById('hashtagInput').value;
      if (hashtags) previewHashtags(hashtags);
    });

    function previewImage(url) {
      const preview = document.getElementById('previewImg');
      const container = document.getElementById('imagePreview');
      
      if (url && url.trim()) {
        preview.src = url;
        preview.style.display = 'block';
        container.style.display = 'block';
        
        preview.onerror = function() {
          container.style.display = 'none';
          M.toast({html: 'Error al cargar la imagen', classes: 'red'});
        };
      } else {
        container.style.display = 'none';
      }
    }

    function previewHashtags(hashtags) {
      const preview = document.getElementById('hashtagPreview');
      
      if (hashtags && hashtags.trim()) {
        const tagArray = hashtags.split(',').map(tag => tag.trim()).filter(tag => tag);
        const chipHTML = tagArray.map(tag => 
          `<span class="chip blue lighten-4 blue-text">#${tag}</span>`
        ).join(' ');
        
        preview.innerHTML = chipHTML;
        preview.style.display = 'block';
      } else {
        preview.innerHTML = '';
        preview.style.display = 'none';
      }
    }
  </script>
</body>
</html>